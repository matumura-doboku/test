<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ加工ツール - 情報表示システム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>データ加工ツール</h1>
                <p class="subtitle">外部APIからデータを取得し、可視化システム用に加工します</p>
            </div>
        </header>

        <main class="main-layout">
            <aside class="sidebar">
                <section class="config-section">
                    <h2>1. 取得データの選択</h2>
                    <div class="form-group">
                        <label for="data-type">データカテゴリー</label>
                        <select id="data-type">
                            <option value="xroad">橋梁の老朽化 (xROAD)</option>
                            <option value="ksj">道路、管路の老朽化 (xROAD,国土数値情報)</option>
                            <option value="resas">都市・経済 (RESAS)</option>
                            <option value="odpt">交通・人流 (公共交通オープンデータ)</option>
                        </select>
                    </div>
                </section>

                <section class="config-section">
                    <h2>2. 地域選択</h2>
                    <div class="form-group">
                        <label for="prefecture">対象都道府県</label>
                        <select id="prefecture">
                            <option value="">都道府県を選択してください</option>
                            <option value="北海道">北海道</option>
                            <option value="青森県">青森県</option>
                            <option value="岩手県">岩手県</option>
                            <option value="宮城県">宮城県</option>
                            <option value="秋田県">秋田県</option>
                            <option value="山形県">山形県</option>
                            <option value="福島県">福島県</option>
                            <option value="茨城県">茨城県</option>
                            <option value="栃木県">栃木県</option>
                            <option value="群馬県">群馬県</option>
                            <option value="埼玉県">埼玉県</option>
                            <option value="千葉県">千葉県</option>
                            <option value="東京都">東京都</option>
                            <option value="神奈川県">神奈川県</option>
                            <option value="新潟県">新潟県</option>
                            <option value="富山県">富山県</option>
                            <option value="石川県">石川県</option>
                            <option value="福井県">福井県</option>
                            <option value="山梨県">山梨県</option>
                            <option value="長野県">長野県</option>
                            <option value="岐阜県">岐阜県</option>
                            <option value="静岡県">静岡県</option>
                            <option value="愛知県">愛知県</option>
                            <option value="三重県">三重県</option>
                            <option value="滋賀県">滋賀県</option>
                            <option value="京都府">京都府</option>
                            <option value="大阪府">大阪府</option>
                            <option value="兵庫県">兵庫県</option>
                            <option value="奈良県">奈良県</option>
                            <option value="和歌山県">和歌山県</option>
                            <option value="鳥取県">鳥取県</option>
                            <option value="島根県">島根県</option>
                            <option value="岡山県">岡山県</option>
                            <option value="広島県">広島県</option>
                            <option value="山口県">山口県</option>
                            <option value="徳島県">徳島県</option>
                            <option value="香川県">香川県</option>
                            <option value="愛媛県">愛媛県</option>
                            <option value="高知県">高知県</option>
                            <option value="福岡県">福岡県</option>
                            <option value="佐賀県">佐賀県</option>
                            <option value="長崎県">長崎県</option>
                            <option value="熊本県">熊本県</option>
                            <option value="大分県">大分県</option>
                            <option value="宮崎県">宮崎県</option>
                            <option value="鹿児島県">鹿児島県</option>
                            <option value="沖縄県">沖縄県</option>
                        </select>
                    </div>
                </section>

                <section class="config-section">
                    <h2>3. APIキー入力</h2>
                    <div class="form-group">
                        <label for="api-key">APIキー</label>
                        <input type="password" id="api-key" placeholder="APIキーを入力してください">
                    </div>
                </section>

                <div class="button-group">
                    <button id="run-btn" class="run-button">データを取得・加工</button>
                    <button id="csv-btn" class="run-button secondary" disabled>CSV出力</button>
                    <button id="send-btn" class="run-button primary" disabled
                        style="background-color: #2563eb; color: white; margin-top: 10px;">メインシステムへ送信</button>
                </div>
            </aside>

            <section class="content-area">
                <div class="panel log-panel">
                    <div class="panel-header">
                        <h3>ステータスログ (Python)</h3>
                        <button id="clear-log" class="text-btn">クリア</button>
                    </div>
                    <div id="status-log" class="log-container">
                        <div class="log-entry system">システム準備完了。設定を入力してください。</div>
                    </div>
                </div>

                <div class="panel preview-panel">
                    <div class="panel-header">
                        <h3>プレビュー</h3>
                        <div id="preview-info" class="preview-info">データ未取得</div>
                    </div>
                    <div class="table-wrapper">
                        <table id="preview-table">
                            <thead>
                                <tr id="table-head">
                                    <!-- 動的に生成 -->
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- 動的に生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        let pyodide;
        const logContent = document.getElementById('status-log');
        const runBtn = document.getElementById('run-btn');
        const csvBtn = document.getElementById('csv-btn');
        let currentData = null;

        // Pythonの出力をログエリアにリダイレクトする関数
        const appendLog = (msg, type = 'info') => {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();

            // msgがオブジェクトの場合は文字列化
            const text = typeof msg === 'string' ? msg : JSON.stringify(msg);
            entry.textContent = `[${time}] ${text}`;

            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
        };

        // Pyodideの初期化
        async function initPyodide() {
            appendLog('Pyodideを初期化中...', 'system');
            try {
                pyodide = await loadPyodide({
                    stdout: (text) => {
                        if (text.startsWith('DEBUG:')) appendLog(text, 'info');
                        else if (text.startsWith('INFO:')) appendLog(text, 'system');
                        else if (text.startsWith('SUCCESS:')) appendLog(text, 'success');
                        else if (text.startsWith('ERROR:')) appendLog(text, 'error');
                        else appendLog(text, 'info');
                    },
                    stderr: (text) => appendLog(text, 'error')
                });

                // main.pyを読み込む
                // bridge.pyを読み込んでファイルシステムに書き込む (import可能にするため)
                const bridgeResponse = await fetch('python/bridge.py');
                const bridgeCode = await bridgeResponse.text();
                pyodide.FS.writeFile('bridge.py', bridgeCode);

                const integratorResponse = await fetch('python/infrastructure_integrator.py');
                const integratorCode = await integratorResponse.text();
                pyodide.FS.writeFile('infrastructure_integrator.py', integratorCode);

                // main.pyを読み込む
                const response = await fetch('python/main.py');
                const code = await response.text();
                await pyodide.runPythonAsync(code);

                appendLog('システムの準備が整いました。', 'success');
                runBtn.disabled = false;
            } catch (err) {
                appendLog(`初期化エラー: ${err.message}`, 'error');
            }
        }

        // 初期状態ではボタンを無効化
        runBtn.disabled = true;
        initPyodide();

        // 実行ボタンのイベント
        runBtn.addEventListener('click', async () => {
            const dataType = document.getElementById('data-type').value;
            const pref = document.getElementById('prefecture').value;
            const apiKey = document.getElementById('api-key').value;

            if (!pref) {
                appendLog('都道府県を選択してください。', 'error');
                return;
            }
            if (!apiKey) {
                appendLog('APIキーを入力してください。', 'error');
                return;
            }

            runBtn.disabled = true;
            runBtn.textContent = '処理中...';

            try {
                // Python関数の実行
                let result;
                if (dataType === 'ksj') {
                    // 統合解析 (infrastructure_integrator.py)
                    result = await pyodide.runPythonAsync(`
                        from infrastructure_integrator import main_process
                        import json
                        data = await main_process("${apiKey}", "${pref}")
                        json.dumps(data)
                    `);
                } else {
                    // 通常取得 (bridge.py)
                    result = await pyodide.runPythonAsync(`
                        from bridge import fetch_xroad_data
                        import json
                        data = await fetch_xroad_data("${apiKey}", "${pref}", "${dataType}")
                        json.dumps(data)
                    `);
                }

                const data = JSON.parse(result);
                if (data && data.length > 0) {
                    renderPreview(data);
                    document.getElementById('preview-info').textContent = `${data.length} 件のデータを表示中`;

                    // データを保存してCSVボタンを有効化
                    currentData = data;
                    csvBtn.disabled = false;
                    sendBtn.disabled = false;
                } else {
                    appendLog('データが取得できなかったか、空でした。', 'error');
                }
            } catch (err) {
                appendLog(`実行エラー: ${err.message}`, 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'データを取得・加工';
            }
        });

        // CSV出力ボタンのイベント
        csvBtn.addEventListener('click', () => {
            if (!currentData || currentData.length === 0) return;

            // CSVデータの生成
            const keys = Object.keys(currentData[0]);
            const header = keys.join(',');
            const rows = currentData.map(row => {
                return keys.map(key => {
                    const val = row[key] === null ? '' : row[key];
                    // ダブルクォートをエスケープして囲む
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',');
            });
            const csvContent = [header, ...rows].join('\n');

            // BOM付きUTF-8でBlobを作成 (Excelでの文字化け防止)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });

            // ダウンロードリンクの生成とクリック
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_export_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // メインシステムへ送信ボタンのイベント
        const sendBtn = document.getElementById('send-btn');
        sendBtn.addEventListener('click', () => {
            if (!currentData || currentData.length === 0) return;

            try {
                // localStorageにデータを保存
                localStorage.setItem('daredemoGIS_imported_data', JSON.stringify(currentData));
                localStorage.setItem('daredemoGIS_import_timestamp', new Date().toISOString());

                appendLog('データをメインシステムへ転送しました。移動します...', 'success');

                // 親ディレクトリのindex.htmlへ移動
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            } catch (e) {
                appendLog('転送エラー: データが大きすぎて保存できませんでした。', 'error');
                console.error(e);
            }
        });

        // プレビューテーブルの描画
        function renderPreview(data) {
            const head = document.getElementById('table-head');
            const body = document.getElementById('table-body');

            head.innerHTML = '';
            body.innerHTML = '';

            if (data.length === 0) return;

            // ヘッダーの作成
            const keys = Object.keys(data[0]);
            keys.forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                head.appendChild(th);
            });

            // データの作成 (最大50件まで表示)
            data.slice(0, 50).forEach(item => {
                const tr = document.createElement('tr');
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.textContent = item[key];
                    body.appendChild(tr.appendChild(td));
                });
                body.appendChild(tr);
            });
        }

        document.getElementById('clear-log').addEventListener('click', () => {
            logContent.innerHTML = '';
        });
    </script>
</body>

</html>